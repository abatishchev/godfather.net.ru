<?xml version="1.0" encoding="UTF-8"?>
<configuration>
 <system.web>
    <customErrors mode="On" />
    <httpCookies httpOnlyCookies="true" requireSSL="true" />
    <httpRuntime targetFramework="4.5" enableVersionHeader="false" />
  </system.web>
  <system.webServer>
    <httpErrors errorMode="Detailed" />
    <rewrite>
      <rules>
        <!-- reverse proxy -->
        <rule name="TFS" stopProcessing="true">
          <match url="(.*)" />
          <conditions logicalGrouping="MatchAll">
            <add input="{HTTP_HOST}" pattern="^tfs\.godfather\.net\.ru$" ignoreCase="true" />
            <add input="{CACHE_URL}" pattern="^(.+)://" />
          </conditions>
          <action type="Rewrite" url="{C:1}://tfs.godfather.home/{R:1}" />
        </rule>
        <rule name="TeamCity" stopProcessing="true">
          <match url="(.*)" />
          <conditions logicalGrouping="MatchAll">
            <add input="{HTTP_HOST}" pattern="^build\.godfather\.net\.ru$" ignoreCase="true" />
            <add input="{CACHE_URL}" pattern="^(.+)://" />
          </conditions>
          <action type="Rewrite" url="http://teamcity.godfather.home/{R:1}" />
        </rule>
        <rule name="Torrent" stopProcessing="true">
          <match url="(.*)" />
          <conditions logicalGrouping="MatchAll">
            <add input="{HTTP_HOST}" pattern="^torrent\.godfather.net\.ru$" />
            <add input="{CACHE_URL}" pattern="^(.+)://" />
          </conditions>
          <action type="Rewrite" url="http://torrent.godfather.home:8080/{R:1}" />
        </rule>
        <!-- local -->
        <rule name="Defending against POODLE, Block SSL3.0" patternSyntax="Wildcard" stopProcessing="true">
          <match url="*" />
          <conditions>
            <add input="{HTTP_X_FORWARDED_SSL30}" pattern="1" />
          </conditions>
          <action type="CustomResponse" statusCode="403" subStatusCode="900" statusReason="Forbidden" statusDescription="SSLv3 connections are forbidden by this site" />
        </rule>
        <rule name="Redirect to HTTPS" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" />
          </conditions>
          <action type="Redirect" redirectType="Permanent" url="https://{HTTP_HOST}{REQUEST_URI}" appendQueryString="false" />
        </rule>
        <rule name="Redirect to Canonical Host Name" stopProcessing="true">
          <match url="(.*)" />
          <conditions logicalGrouping="MatchAll">
            <add input="{HTTP_HOST}" pattern="^godfather\.net\.ru$" negate="true" />
            <add input="{CACHE_URL}" pattern="^(.+)://" />
          </conditions>
          <action type="Redirect" url="{C:1}://godfather.net.ru{REQUEST_URI}" appendQueryString="false" redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>
        <security>
		<requestFiltering>
                	<fileExtensions>
                    		<remove fileExtension=".apk" />
                	</fileExtensions>
            	</requestFiltering>
        </security>
	<httpProtocol>
		<customHeaders>
        		<remove name="X-Powered-By" />
			<add name="X-Frame-Options" value="DENY" />
		</customHeaders>
	</httpProtocol>
  </system.webServer>
</configuration>